<!DOCTYPE html>
<html lang="en">
<head>
	<title>Get your freaking timetable</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->
	<link rel="icon" type="image/png" href="/static/assets/images/icons/favicon.ico"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/vendor/bootstrap/css/bootstrap.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/vendor/animate/animate.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/vendor/css-hamburgers/hamburgers.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/vendor/select2/select2.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="/static/assets/css/util.css">
	<link rel="stylesheet" type="text/css" href="/static/assets/css/main_updated.css">
<!--===============================================================================================-->
</head>
<body>
<style>
    #loading {
    position: absolute; width: 100%; height: 100%; background: url('/static/spinner2.gif') no-repeat center center; z-index: 100;
}
</style>
<div id="loading"></div>

  <div id="overlay" style="display:none;"></div>
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Modal Header</h4>
        </div>
        <div class="modal-body">
          <p>Some text in the modal.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>

    </div>
  </div>


	<div class="limiter">
		<div class="container-login100">
			<div class="wrap-login100">
				<div class="login100-pic js-tilt" style="position: relative;" data-tilt>
					<img style="position: absolute; top: 0; bottom: 0; left: 0; right: 0; margin: auto;" src="/static/assets/images/img-01.png" alt="IMG">
				</div>
				<form id="loginform" class="login100-form validate-form" onkeypress="return event.keyCode != 13;" onsubmit="event.preventDefault(); ">

					<span class="login100-form-title">
						Get your freaking timetable
					</span>

					<div class="wrap-input100" id="divshown">
						<input class="input100" type="text" name="loginusername" placeholder="ERP Roll Number">


						<span class="focus-input100"></span>
						<span class="symbol-input100">
							<i class="fa fa-id-badge" aria-hidden="true"></i>
						</span>
					</div>

					<div class="container-login100-form-btn">
						<button class="login100-form-btn" type="submit" onclick="getSecurityQues()">
						Get Security Question
						</button>
					</div>

					<br/><br/>
					<div id="second-step" style="display: none;">
						<div class="wrap-input100">
							<input class="input100" type="text" name="securityquestion" id="security-question" readonly="readonly">
	
	
							<span class="focus-input100"></span>
							<span class="symbol-input100">
								<i class="fa fa-question-circle-o" aria-hidden="true"></i>
							</span>
						</div>
						<div class="wrap-input100" id="divshown">
							<input class="input100" type="password" name="securityanswer" placeholder="Security Question's Answer">
	
	
							<span class="focus-input100"></span>
							<span class="symbol-input100">
								<i class="fa fa-pencil-square-o" aria-hidden="true"></i>
							</span>
						</div>
						<div class="wrap-input100" id="divshown">
	
							<input class="input100" type="password" name="loginpassword" placeholder="ERP Password">
	
	
							<span class="focus-input100"></span>
							<span class="symbol-input100">
								<i class="fa fa-key" aria-hidden="true"></i>
							</span>
						</div>
						<div class="container-login100-form-btn">
							<button title="download timetable in ICS format from erp" class="login100-form-btn" type="submit" onclick="login();">
							Download ICS
							</button>
						</div>
					</div>

					<!-- after timetable download -->
					<div id="third-step" style="display: none;">
						<div class="container-login100-form-btn">
							<button title="import ICS file to your google calendar" id="add-to-calendar" class="login100-form-btn" type="submit" target="_blank" style="opacity: 0.4; cursor: default !important; pointer-events: none; color: white;">add to Google calendar</button>
						</div>
					</div>
				</form>
				<div class="footer p-t-136" style="text-align: center; width: 100%;">
					Maintained by 
					<a style="cursor: pointer;" class="txt2" target="_blank" href="https://metakgp.github.io/">
						MetaKGP
					</a>
					with <span style="font-size:150%;color:red;">❤️</span> at 
					<a style="cursor: pointer;" target="_blank" href="https://github.com/metakgp/gyft-serve">
						GitHub <img src="/static/assets/images/icons/github.png"/>
					</a>
				</div>
			</div>

			<div class="wrap-info">
				<button type="button" class="learn-more-btn">How to use downloaded ICS file?</button>
				<div class="learn-more-content">
					<br />
					<h5>What in an ICS file?</h5>
					<p>
						An ICS file is a universal calendar format supported by several email and calendar programs including Microsoft Outlook, Google Calendar, and Apple Calendar. It enables users to publish and share calendar information on the web and over email.
                        ICS files are often used for sending meeting requests to other users, who can import the events into their calendars.
					</p>
					<br />
					<h5>How to add ICS file to your calendar?</h5>
					<p>
						An ICS file can be added to a lot of calendars other than Google calendar. The following points are links to a few of those calendars but don't worry if you don't find your favorite calendar here, try searching for it on the internet.
						<ul>
							<li>
								<a style="cursor: pointer; font-weight: bold; font-size: 15px;" target="_blank" href="https://support.microsoft.com/en-us/office/import-or-subscribe-to-a-calendar-in-outlook-com-cff1429c-5af6-41ec-a5b4-74f2c278e98c">Outlook</a>
							</li>
							<li>
								<a style="cursor: pointer; font-weight: bold; font-size: 15px;" target="_blank" href="https://support.apple.com/en-in/guide/calendar/icl1023/mac">Apple Calendar</a>
							</li>
						</ul>
					</p>
				</div>
			</div>
		</div>
	</div>

</body>

<!--===============================================================================================-->
	<script src="/static/assets/vendor/jquery/jquery-3.2.1.min.js"></script>
<!--===============================================================================================-->
	<script src="/static/assets/vendor/bootstrap/js/popper.js"></script>
	<script src="/static/assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<!--===============================================================================================-->
	<script src="/static/assets/vendor/select2/select2.min.js"></script>
<!--===============================================================================================-->
	<script src="/static/assets/vendor/tilt/tilt.jquery.min.js"></script>
	<script >
		$('.js-tilt').tilt({
			scale: 1.1
		})
	</script>
<!--===============================================================================================-->
	<script src="/static/assets/js/main.js"></script>

	<script type="text/javascript">
		$('#signupform').toggle();
		var results = [];
		var toggleView = function() {
			$('#loginform').toggle();
			$('#signupform').toggle();
			$('#lblCreateAccount').toggle();
		}
	function download(filename, text) {
	  var element = document.createElement('a');
	  element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + escape(text));
	  element.setAttribute('download', filename);

	  element.style.display = 'none';
	  document.body.appendChild(element);

	  element.click();

	  document.body.removeChild(element);
	}
	var temp = "";

	// function for enabling link to google calendar and colouring of instructions

	function enableButton(){
		$("#add-to-calendar").attr("onclick", "window.open('https://calendar.google.com/calendar/r/settings/export?tab=wc', '_blank')");
		$("#add-to-calendar").removeAttr("style");
		$("#instructions-timetable").removeAttr("style");
		$("#instructions-next-step").css("color", "red");
	}
		var login = function() {
			$('#loading').show();
			var data = new FormData()
			var username = $('input[name=loginusername]').val()
			var security_answer = $('input[name=securityanswer]').val()
			var password = $('input[name=loginpassword]').val()
			// var password = $('input[name=loginpassword]').val()

			data.append('user_id', username)
			data.append('security_answer', security_answer)
			data.append('password', password)
			data.append('sessionToken', results[1])
			// data.append('password', password)
			// var url = 'http://localhost:5000/login'
			// console.log(data, username, security_answer, results[1])
			var url = "{{url_for('user')}}"
			var request = new XMLHttpRequest()
			request.open("POST", url , true)


			request.onload = function () {
		    // do something to response

			    if (!(request.readyState == XMLHttpRequest.DONE && request.status == 200) || (this.responseText == "error occured" || this.responseText == "wrong credentials")) {
			    	console.log("error");
			    	// console.log(this.responseText);
			    	console.log(request.readyState, request.status);
					if (this.responseText == "error occured") {
			    		alert("Possibly some error occured. \nIs your password/secret answer correct? Try again!");
					}
					else if (this.responseText == "wrong credentials") {
			    		alert("The entered credentials are wrong. Try again!");
					}

			    	// window.open("http://localhost:5000/", "_self");
			    	window.open("{{url_for('homepage')}}", "_self");
			    }
			    else {
			    	// console.log(this.responseText);
			    	t = eval(this.responseText)
			    	temp = t[0];
			   		download("Timetable.ics", t[0]);
					enableButton();
					document.getElementById('third-step').style.display = "block";
			    }
				$('#loading').hide();
			};
			// console.log("sending");
			request.send(data)

		}

		var getSecurityQues = function() {
			$('#loading').show();
			// console.log("call ho raha getsec ")
			var data = new FormData()

			var username = $('input[name=loginusername]').val()
			// var password = $('input[name=loginpassword]').val()

			data.append('user_id', username)
			// data.append('password', password)
			// console.log(data);
			// var url = 'http://localhost:5000/getques'
			var url = "{{url_for('getques')}}"
			var request = new XMLHttpRequest()
			request.open("POST", url , true)
			request.onload = function () {


    // console.log (this.responseText);
    		// do something to response
		    if (this.responseText == "error occured"){
		    	console.log("error");
		    	alert("Possibly some error occured. \nIs your roll number correct? Try again!")
			}
		    else
		    	{
					document.getElementById('second-step').style.display = "block";
		    		results = eval(this.responseText);
					document.getElementById('security-question').value = results[0];
    			}
			$('#loading').hide();
};
			request.send(data)
		}
$(window).ready(function() {
    $('#loading').hide();
});

	var coll = document.getElementsByClassName("learn-more-btn");
	var i;

	for (i = 0; i < coll.length; i++) {
		coll[i].addEventListener("click", function() {
			this.classList.toggle("active");
			var content = this.nextElementSibling;
			if (content.style.maxHeight){
				content.style.maxHeight = null;
			} else {
				content.style.maxHeight = content.scrollHeight + "px";
			}
		});
	}

	</script>
</html>
